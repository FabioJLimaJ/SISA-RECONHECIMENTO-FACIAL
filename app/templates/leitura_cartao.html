{%extends 'base.html' %}

{% block titulo %} Leitura de cartão {% endblock %}


{% block conteudo%}

<style type="text/tailwindcss">
  @layer utilities {
    .glow-green {
      box-shadow:0 0 20px 10px rgba(20, 83, 45, 0.5);
    }
    .glow-red {
      box-shadow:0 0 20px 10px rgba(127, 29, 29, 0.5);
    }
    .fade-out-tailwind {
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  }
</style>



<main class="max-w-7xl mx-auto py-6 px-4 mt-16 sm:px-6 lg:px-8 ">
  <div class="max-w-2xl mx-auto">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden transition ">

      <!-- Cabeçalho -->
      <div class="bg-[#007BFF] px-6 py-4">
        <h1 class="text-2xl font-bold text-white flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-credit-card w-6 h-6 mr-3">
            <rect width="20" height="14" x="2" y="5" rx="2"></rect>
            <line x1="2" x2="22" y1="10" y2="10"></line>
          </svg>
          Leitura do Cartão de Estudante
        </h1>
      </div>

      <!-- Corpo -->
      <div class="p-8">
        <!-- Ícone e texto inicial -->
        <div class="text-center mb-8">
          <div id="highlight" class="bg-gray-900 rounded-lg overflow-hidden aspect-video transform scale-x-[-1]">
            <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
            <canvas id="canvas" hidden></canvas>
            <div id="result">Aponte a câmera para o QR Code...</div>
          </div>
          <h2 class="text-xl font-semibold text-gray-900 mb-2">
            Sistema de Leitura com QR Code
          </h2>
          <p class="resultado text-lg font-medium text-gray-600">
            Aproxime seu cartão do leitor de QR Code
          </p>
        </div>

 
        <div class="space-y-6">
          <div>
            <div class="bg-gray-50 rounded-lg p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Instruções</h3>
              <div class="grid sm:grid-cols-2 gap-4">
                <div class="flex items-start space-x-3">
                  <div class="flex-shrink-0 w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center">
                    <span class="text-xs font-bold text-purple-600">1</span>
                  </div>
                  <div>
                    <h4 class="font-medium text-gray-900">Leitura</h4>
                    <p class="text-sm text-gray-600">Aproxime o QR Code presente no verso do seu cartão da Fatec no
                      leitor</p>
                  </div>
                </div>
                <div class="flex items-start space-x-3">
                  <div class="flex-shrink-0 w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center">
                    <span class="text-xs font-bold text-purple-600">2</span>
                  </div>
                  <div>
                    <h4 class="font-medium text-gray-900">Validação</h4>
                    <p class="text-sm text-gray-600">Se estiver cadastrado, o sistema irá liberar o acesso a você</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
</main>


<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const resultado = document.querySelector("#result");
  const resp = document.querySelector(".resultado");
  const glow = document.getElementById("highlight");
  let scanning = true;
  let stream = null;


  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');


  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(s => {
      stream = s;
      video.srcObject = stream;
      video.play();
      requestAnimationFrame(scanQRCode);
    })
    .catch(err => {
      resultado.innerText = "Erro ao acessar a câmera: " + err;
    });


  function stopCamera() {
    scanning = false;
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
    console.log("Câmera parada");
  }
  function startCameraAgain() {
    if (stream) {

      stream.getTracks().forEach(track => track.stop());
    }

    scanning = true;

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(s => {
        stream = s;
        video.srcObject = stream;
        video.play();
        requestAnimationFrame(scanQRCode);
        setTimeout(() => {
          resp.innerText = "Câmera reativada. Aponte para o QR Code...";
        }, 4000);
        console.log("Câmera reiniciada");
      })
      .catch(err => {
        resp.innerText = "Erro ao reativar a câmera: " + err;
      });
  }


  function scanQRCode() {
    if (!scanning) return;

    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

      if (code) {
        resp.textContent = "analisando cartão";
        stopCamera();


        fetch('/verificar/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({ url: code.data })
        })
          .then(response => response.json())
          .then(data => {

            if (data.mensagem) {

              if (data.mensagem === "Liberado") {
                glow.classList.add("glow-green");


                resp.innerHTML = `<div
    role="alert"
    class="bg-green-100 dark:bg-green-900 border-l-4 border-green-500 dark:border-green-700 text-green-900 dark:text-green-100 p-2 rounded-lg flex items-center transition duration-300 ease-in-out hover:bg-green-200 dark:hover:bg-green-800 transform hover:scale-105"
  >
    <svg
      stroke="currentColor"
      viewBox="0 0 24 24"
      fill="none"
      class="h-5 w-5 flex-shrink-0 mr-2 text-green-600"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M13 16h-1v-4h1m0-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        stroke-width="2"
        stroke-linejoin="round"
        stroke-linecap="round"
      ></path>
    </svg>
    <p class="text-xs font-semibold">Sucesso - Liberado</p>
  </div>`;
                setTimeout(() => {
                  glow.classList.remove("glow-green", "glow-red");
                  resp.innerText = "Aponte a câmera para o QR Code...";
                }, 6000);
              }
              else if (data.mensagem === "Aluno não encontrado") {
                glow.classList.add("glow-red");

                resp.innerHTML = `<div
    role="alert"
    class="bg-red-100 dark:bg-red-900 border-l-4 border-red-500 dark:border-red-700 text-red-900 dark:text-red-100 p-2 rounded-lg flex items-center transition duration-300 ease-in-out hover:bg-red-200 dark:hover:bg-red-800 transform hover:scale-105"
  >
    <svg
      stroke="currentColor"
      viewBox="0 0 24 24"
      fill="none"
      class="h-5 w-5 flex-shrink-0 mr-2 text-red-600"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M13 16h-1v-4h1m0-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        stroke-width="2"
        stroke-linejoin="round"
        stroke-linecap="round"
      ></path>
    </svg>
    <p class="text-xs font-semibold">Erro- Aluno não encontrado.</p>
  </div>`;
                setTimeout(() => {
                  glow.classList.remove("glow-green", "glow-red");
                  resp.innerText = "Aponte a câmera para o QR Code...";
                }, 6000);
              }
              startCameraAgain();
            }

          })
          .catch(error => {
            console.error('Erro:', error);
            resp.innerText = "Erro ao enviar dados.";
          });

        return;
      } else {

      }
    }

    requestAnimationFrame(scanQRCode);
  }

</script>

{% endblock %}